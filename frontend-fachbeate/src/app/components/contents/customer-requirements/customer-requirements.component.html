<div class="header">
    <div>
        <h1 class="paddingSearch">{{"REQ-TECH.title" | translate}}</h1>
    </div>
    <div>
        <button [disabled]="inputCustomerRequirement.releaseManagement !== null && inputCustomerRequirement.releaseManagement !== undefined" (nzOnConfirm)="release('gl')" *ngIf="roleService.checkPermission([1,7])" style="margin-right: 2rem;"
            nz-button nzType="primary" nz-popconfirm nzPopconfirmShowArrow="false" [nzIcon]="iconTpl"
            nzPopconfirmTitle="Sind Sie sicher?">
            <ng-template #iconTpl></ng-template>
            Freigabe GL
        </button>
        <button [disabled]="inputCustomerRequirement.releaseSupervisor !== null && inputCustomerRequirement.releaseSupervisor !== undefined" (nzOnConfirm)="release('al')" *ngIf="roleService.checkPermission([1,2,7])" style="margin-right: 2rem;"
            nz-button nzType="primary" nz-popconfirm nzPopconfirmShowArrow="false" [nzIcon]="iconTpl"
            nzPopconfirmTitle="Sind Sie sicher?">
            <ng-template #iconTpl></ng-template>
            Freigabe AL
        </button>
    </div>
    <div>
        <button *ngIf="(inputCustomerRequirement.creator === undefined && roleService.checkPermission([6])) || roleService.checkPermission([1,2,3,4,5,7])" class="btn btn-success" (click)="postCustomerRequirement()">{{"REQ-TECH.send" | translate}}</button>
    </div>
</div>
<hr>
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header  text-white bg-danger">{{"REQ-TECH.card1-title"|translate}}</div>
            <div class="card-body">
                <div class="center-items">
                    <div class="center-items ">
                        <mat-form-field>
                            <mat-label>{{"REQ-TECH.dealers"|translate}}</mat-label>
                            <mat-select
                                [ngModel]="(inputCustomerRequirement.company === undefined)?undefined:inputCustomerRequirement.company.id"
                                (valueChange)="changeCompany($event)">
                                <mat-option>--</mat-option>
                                @for (c of companies; track companies) {
                                <mat-option [value]="c.id">{{c.name}}</mat-option>
                                }
                            </mat-select>
                            @if (tohaControl.hasError('required')) {
                            <mat-error>{{"REQ-TECH.none-select" | translate}}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                    <div class="center-items ">
                        <mat-form-field>
                            <mat-label>{{"REQ-TECH.representative"|translate}}</mat-label>
                            <mat-select
                                [ngModel]="(inputCustomerRequirement.representative === undefined)?undefined:inputCustomerRequirement.representative.id"
                                (valueChange)="changeRepresentative($event)" required>
                                <mat-option>--</mat-option>
                                @for (r of representative; track representative) {
                                <mat-option [value]="r.id">{{r.firstName}} {{r.lastName}}</mat-option>
                                }
                            </mat-select>
                            @if (tohaControl.hasError('required')) {
                            <mat-error>{{"REQ-TECH.none-select" | translate}}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-header  text-white bg-danger">{{"REQ-TECH.card2-title"|translate}}</div>
            <div class="card-body">
                <div class="center-items">
                    <div class="center-items">
                        <mat-form-field>
                            <mat-label>{{"REQ-TECH.technologist"|translate}}</mat-label>
                            <mat-select
                                [ngModel]="(inputCustomerRequirement.requestedTechnologist === undefined)?undefined:inputCustomerRequirement.requestedTechnologist.id"
                                (valueChange)="changeTechnolgist($event)" required>
                                <mat-option>--</mat-option>
                                @for (t of technologists; track technologists) {
                                <mat-option [value]="t.id">{{t.firstName}} {{t.lastName}}</mat-option>
                                }
                            </mat-select>
                            @if (tohaControl.hasError('required')) {
                            <mat-error>{{"REQ-TECH.none-select" | translate}}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                </div>
                <mat-form-field>
                    <mat-label>{{"REQ-TECH.from-to-date"|translate}}</mat-label>
                    <mat-date-range-input [rangePicker]="picker">
                        <input required matStartDate placeholder="Start date"
                            [(ngModel)]="inputCustomerRequirement.startDate">
                        <input required matEndDate placeholder="End date"
                            [(ngModel)]="inputCustomerRequirement.endDate">
                    </mat-date-range-input>
                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-date-range-picker #picker></mat-date-range-picker>
                    <!-- TODO mÃ¶gliche Fehlerquelle-->
                    @if (tohaControl.hasError('required')) {
                    <mat-error>{{"REQ-TECH.none-select" | translate}}</mat-error>
                    }
                </mat-form-field>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-header  text-white bg-danger">{{"REQ-TECH.card3-title"|translate}}</div>
            <div class="card-body">
                <div class="center-items">
                    <div class="center-items ">
                        <mat-form-field>
                            <mat-label>{{"REQ-TECH.flight-booking"|translate}}</mat-label>
                            <mat-select [(ngModel)]="inputCustomerRequirement.flightBooking">
                                <mat-option>--</mat-option>
                                <mat-option [value]="true">Almi</mat-option>
                                <mat-option [value]="false">{{"REQ-TECH.selction-customer" | translate}}</mat-option>
                            </mat-select>
                            @if (tohaControl.hasError('required')) {
                            <mat-error>{{"REQ-TECH.none-select" | translate}}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                    <div class="center-items ">
                        <mat-form-field>
                            <mat-label>{{"REQ-TECH.hotel-booking"|translate}}</mat-label>
                            <mat-select [(ngModel)]="inputCustomerRequirement.hotelBooking">
                                <mat-option>--</mat-option>
                                <mat-option [value]="true">Almi</mat-option>
                                <mat-option [value]="false">{{"REQ-TECH.selction-customer" | translate}}</mat-option>
                            </mat-select>
                            @if (tohaControl.hasError('required')) {
                            <mat-error>{{"REQ-TECH.none-select" | translate}}</mat-error>
                            }
                        </mat-form-field>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-header  text-white bg-danger">{{"REQ-TECH.card4-title"|translate}}</div>
            <div class="card-body">
                <div class="center-items">
                    <mat-form-field>
                        <mat-label>{{"REQ-TECH.further-notes"|translate}}</mat-label>
                        <input matInput [(ngModel)]="inputCustomerRequirement.furtherNotes">
                    </mat-form-field>
                    <mat-form-field>
                        <mat-label>{{"REQ-TECH.contact-person"|translate}}</mat-label>
                        <input matInput [(ngModel)]="inputCustomerRequirement.contact">
                    </mat-form-field>
                </div>
            </div>
        </div>
    </div>
</div>
<br>


<br>
<div class="header">
    <h1 style="margin: 0%;">{{"REQ-TECH.table-title"|translate}}</h1>
    <button nz-button (click)="addRow()" nzType="primary">{{"REQ-TECH.new-customerVisit"|translate}}</button>
</div>
<hr>
<div class="row">
    <nz-table class="col" #editRowTable nzTableLayout="fixed" nzBordered
        [nzData]="inputCustomerRequirement.customerVisits!">
        <thead>
            <tr>
                <th>{{"REQ-TECH.customer-name" | translate}}</th>
                <th>{{"REQ-TECH.customerNr" | translate}}</th>
                <th>{{"REQ-TECH.adress" | translate}}</th>
                <th>{{"REQ-TECH.contact-person-table" | translate}}</th>
                <th>{{"REQ-TECH.date-of-visit" | translate}}</th>
                <th>{{"REQ-TECH.reason" | translate}}</th>
                <th>{{"REQ-TECH.productionAmount" | translate}}</th>
                <th>{{"REQ-TECH.edit-delete" | translate}}</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let data of editRowTable.data" class="editable-row">
                <td>
                    <label class="input-label" [hidden]="editId === data.editId"
                        (click)="startEdit(data.editId)">{{data.companyName}}</label>
                    <input placeholder="Pflichtfeld*" [hidden]="editId !== data.editId" type="text" nz-input [(ngModel)]="data.companyName" />
                </td>
                <td>
                    <label class="input-label" [hidden]="editId === data.editId"
                        (click)="startEdit(data.editId)">{{data.customerNr}}</label>
                    <input [hidden]="editId !== data.editId" type="text" nz-input [(ngModel)]="data.customerNr" />
                </td>
                <td>
                    <label class="input-label" [hidden]="editId === data.editId"
                        (click)="startEdit(data.editId)">{{data.address}}</label>
                    <input  placeholder="Pflichtfeld*"  [hidden]="editId !== data.editId" type="text" nz-input [(ngModel)]="data.address" />
                </td>
                <td>
                    <label class="input-label" [hidden]="editId === data.editId"
                        (click)="startEdit(data.editId)">{{data.contactPerson}}</label>
                    <input [hidden]="editId !== data.editId" type="text" nz-input [(ngModel)]="data.contactPerson" />
                </td>
                <td>
                    <label class="input-label" [hidden]="editId === data.editId" (click)="startEdit(data.editId)">{{
                        (data.dateOfVisit !== undefined)?data.dateOfVisit!.toString().substring(0,10):''}}</label>
                    <input  placeholder="Pflichtfeld*"  [hidden]="editId !== data.editId" type="date" nz-input [(ngModel)]="data.dateOfVisit" />
                </td>
                <td class="multiple-select">
                    <mat-select  placeholder="Pflichtfeld*"  multiple placeholder="{{'REQ-TECH.select'|translate}} " [ngModel]="data.selection"
                        (selectionChange)="selChange($event, data.editId)">
                        <mat-option [value]="1">{{"REQ-TECH.presentationOfNewProducts" | translate}}</mat-option>
                        <mat-option [value]="2">{{"REQ-TECH.existingProducts" | translate}}</mat-option>
                        <mat-option [value]="3">{{"REQ-TECH.recipeOptimization" | translate}}.</mat-option>
                        <mat-option [value]="4">{{"REQ-TECH.sampleProduction" | translate}}</mat-option>
                        <mat-option [value]="5">{{"REQ-TECH.training" | translate}}</mat-option>
                    </mat-select>
                </td>
                <td>
                    <label class="input-label" [hidden]="editId === data.editId"
                        (click)="startEdit(data.editId)">{{data.productionAmount}}</label>
                    <input nz-input [hidden]="editId !== data.editId" type="text" [(ngModel)]="data.productionAmount" />
                </td>
                <td>
                    <div class="flugHotel"> <button matTooltip="{{'REQ-TECH.edit' | translate}}" class="btn btn-success"
                            (click)="startEdit(data.editId)" [hidden]="editId === data.editId">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button matTooltip="{{'REQ-TECH.save' | translate}}" class="btn btn-success"
                            (click)="stopEdit()" [hidden]="editId !== data.editId">
                            <i class="fa fa-save"></i>
                        </button>
                        <button matTooltip="{{'REQ-TECH.delete' | translate}}" class="btn btn-danger" nz-popconfirm
                            nzPopconfirmShowArrow="false" [nzIcon]="iconTpl" nzPopconfirmTitle="Sind Sie sicher?"
                            (nzOnConfirm)="deleteRow(data.editId)">
                            <ng-template #iconTpl>
                                <span nz-icon nzType="question-circle-o" style="color: red;"></span>
                            </ng-template>
                            <i class="fa fa-trash"></i>
                        </button>
                        <button *ngIf="roleService.checkPermission([1,2,3,4])" class="btn btn-success"
                            matTooltip="Abschlussbericht" (click)="openDialog(data)">
                            <i class="fa fa-file"></i>
                        </button>
                    </div>
                </td>
            </tr>
        </tbody>
    </nz-table>
</div>
